workflows:
  ios_simulator_screens:
    name: iOS Simulator - Build + Screens
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      flutter: "3.35.7"
      xcode: latest
      cocoapods: default
    cache:
      cache_paths:
        - $HOME/Library/Caches/CocoaPods
        - ~/.cocoapods
        - ios/Pods
        - $HOME/.pub-cache
        - ios/build/Build
    scripts:
      - name: Place GoogleService-Info.plist
        script: |
          if [ -f "GoogleService-Info.plist" ]; then
            echo "Found GoogleService-Info.plist at repo root. Copying to ios/Runner";
            cp GoogleService-Info.plist ios/Runner/GoogleService-Info.plist;
            /usr/libexec/PlistBuddy -c 'Set :BUNDLE_ID br.com.pratoseguro.app' ios/Runner/GoogleService-Info.plist || true
          else
            echo "GoogleService-Info.plist not found at repo root. Continuing without it.";
          fi
      - name: Flutter pub get
        script: |
          flutter --version
          flutter clean
          flutter pub get
      - name: Install CocoaPods
        script: |
          cd ios
          rm -rf Pods Podfile.lock
          pod --version
          pod install --repo-update
      - name: Verify Pods flags
        script: |
          cd ios
          if grep -R -- "-GCC_WARN_INHIBIT_ALL_WARNINGS" Pods -n; then
            echo "Invalid '-GCC_WARN_INHIBIT_ALL_WARNINGS' flag found in Pods. Failing early."
            exit 1
          fi
      - name: Clean response files
        script: |
          cd ios
          echo "ðŸ§¹ Cleaning .resp files to strip '-GCC_WARN_INHIBIT_ALL_WARNINGS'"
          find build -name '*.resp' -type f 2>/dev/null | while read -r f; do
            if grep -q -- "-GCC_WARN_INHIBIT_ALL_WARNINGS" "$f"; then
              echo "Cleaning $f"
              sed -i '' 's/-GCC_WARN_INHIBIT_ALL_WARNINGS//g' "$f"
            fi
          done || true
      - name: Xcode diagnostics
        script: |
          xcodebuild -version
          xcodebuild -showsdks
          xcodebuild -list -workspace ios/Runner.xcworkspace || xcodebuild -list -project ios/Runner.xcodeproj || true
          xcodebuild -showdestinations -workspace ios/Runner.xcworkspace -scheme Runner -sdk iphonesimulator || true
      - name: Create & boot simulator
        script: |
          echo "ðŸ” Selecting available iOS runtime..."
          RUNTIMES=$(xcrun simctl list runtimes | grep -E '^iOS [0-9]+' | grep -v unavailable | sed -nE 's/.*(com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+).*/\1/p' | tail -r)
          if [ -z "$RUNTIMES" ]; then
            echo "No available iOS simulators found"
            exit 1
          fi
          DEVICE_NAMES=("iPhone 15" "iPhone 14" "iPhone 15 Pro" "iPhone SE (3rd generation)")
          CREATED=""
          for RUNTIME_ID in $RUNTIMES; do
            for NAME in "${DEVICE_NAMES[@]}"; do
              LINE=$(xcrun simctl list devicetypes | grep -F -i "$NAME (" | head -1)
              if [ -n "$LINE" ]; then
                DTYPE_ID=$(echo "$LINE" | tr '()' '\n' | grep -E 'com\.apple\.CoreSimulator\.SimDeviceType\.' | head -1)
              else
                DTYPE_ID=""
              end if
              [ -z "$DTYPE_ID" ] && continue
              if DEVICE_UDID=$(xcrun simctl create "CM iPhone" "$DTYPE_ID" "$RUNTIME_ID" 2>/dev/null); then
                CREATED=1
                DEVICE_NAME="$NAME"
                SELECTED_RUNTIME="$RUNTIME_ID"
                break 2
              fi
            done
          done
          if [ -z "$CREATED" ]; then
            echo "Failed to create simulator"
            exit 1
          fi
          xcrun simctl boot "$DEVICE_UDID" || true
          xcrun simctl bootstatus "$DEVICE_UDID" -b
          echo "export DEVICE_UDID=\"$DEVICE_UDID\"" >> $CM_ENV
          echo "export DEVICE_NAME=\"$DEVICE_NAME\"" >> $CM_ENV
          echo "export SELECTED_RUNTIME=\"$SELECTED_RUNTIME\"" >> $CM_ENV
          OS_VERSION=$(echo "$SELECTED_RUNTIME" | sed -nE 's/.*iOS-([0-9]+)-([0-9]+).*/\1.\2/p')
          if [ -z "$OS_VERSION" ]; then
            OS_VERSION=$(echo "$SELECTED_RUNTIME" | sed -nE 's/.*iOS-([0-9]+)-([0-9]+).*/\1.\2/p')
          fi
          echo "export OS_VERSION=\"$OS_VERSION\"" >> $CM_ENV
      - name: Build iOS (Debug, simulator)
        script: |
          cd ios
          source $CM_ENV || true
          echo "DEVICE_UDID=$DEVICE_UDID"
          echo "DEVICE_NAME=$DEVICE_NAME"
          echo "OS_VERSION=$OS_VERSION"
          set -e
          if [ -n "$DEVICE_UDID" ]; then
            echo "ðŸ“± Building for simulator UDID: $DEVICE_UDID"
            xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Debug -sdk iphonesimulator -destination "id=$DEVICE_UDID" -derivedDataPath build clean build | tee xcodebuild.log
          elif [ -n "$DEVICE_NAME" ] && [ -n "$OS_VERSION" ]; then
            echo "ðŸ“± Building for simulator: $DEVICE_NAME, iOS $OS_VERSION"
            xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Debug -sdk iphonesimulator -destination "platform=iOS Simulator,name=$DEVICE_NAME,OS=$OS_VERSION" -derivedDataPath build clean build | tee xcodebuild.log
          else
            echo "ðŸ“± Building for generic iOS Simulator"
            xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Debug -sdk iphonesimulator -destination "generic/platform=iOS Simulator" -derivedDataPath build clean build | tee xcodebuild.log
          fi
          echo "ðŸ§¹ Post-build: cleaning any .resp files that may have been recreated"
          find build -name '*.resp' -type f 2>/dev/null -exec grep -l -- "-GCC_WARN_INHIBIT_ALL_WARNINGS" {} \; | while read -r f; do
            echo "Re-cleaning $f"
            sed -i '' 's/-GCC_WARN_INHIBIT_ALL_WARNINGS//g' "$f"
          done || true
          SIMULATOR_APP_PATH="build/Build/Products/Debug-iphonesimulator/Runner.app"
          if [ ! -d "$SIMULATOR_APP_PATH" ]; then
            echo "App not built at $SIMULATOR_APP_PATH"
            exit 1
          fi
      - name: Install and launch
        script: |
          DEVICE_ID=${DEVICE_UDID:-booted}
          SIMULATOR_APP_PATH="ios/build/Build/Products/Debug-iphonesimulator/Runner.app"
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print:CFBundleIdentifier' "$SIMULATOR_APP_PATH/Info.plist" 2>/dev/null || echo "br.com.pratoseguro.app")
          xcrun simctl install "$DEVICE_ID" "$SIMULATOR_APP_PATH" || xcrun simctl install booted "$SIMULATOR_APP_PATH"
          xcrun simctl launch "$DEVICE_ID" "$BUNDLE_ID" || true
      - name: Capture media
        script: |
          set -e
          DEVICE_ID=${DEVICE_UDID:-booted}
          mkdir -p cm-artifacts
          xcrun simctl io "$DEVICE_ID" screenshot cm-artifacts/screenshot.png || true
          xcrun simctl io "$DEVICE_ID" screenshot cm-artifacts/screenshot2.png || true
          xcrun simctl io "$DEVICE_ID" recordVideo --type=mp4 cm-artifacts/demo.mp4 & VID=$!
          sleep 12
          kill -INT $VID || true
          wait $VID || true
      - name: Package Runner.app
        script: |
          tar -czf cm-artifacts/Runner.app.tgz -C ios/build/Build/Products/Debug-iphonesimulator Runner.app
      - name: Cleanup simulator
        script: |
          xcrun simctl shutdown "$DEVICE_UDID" || true
          xcrun simctl delete "$DEVICE_UDID" || true
    artifacts:
      - cm-artifacts/**
      - ios/build/Build/Products/Debug-iphonesimulator/Runner.app
      - xcodebuild.log

  ios_store_screenshots:
    name: iOS - App Store Screenshots (Manual)
    max_build_duration: 90
    instance_type: mac_mini_m2
    environment:
      flutter: "3.35.7"
      xcode: latest
      cocoapods: default
    cache:
      cache_paths:
        - $HOME/Library/Caches/CocoaPods
        - ~/.cocoapods
        - ios/Pods
        - $HOME/.pub-cache
        - ios/build/Build
    scripts:
      - name: Flutter pub get
        script: |
          flutter --version
          flutter clean
          flutter pub get

      - name: Install CocoaPods
        script: |
          cd ios
          rm -rf Pods Podfile.lock
          pod --version
          pod install --repo-update

      - name: Create & boot simulator for build
        script: |
          echo "ðŸ” Selecting available iOS runtime..."
          RUNTIMES=$(xcrun simctl list runtimes | grep -E '^iOS [0-9]+' | grep -v unavailable | sed -nE 's/.*(com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+).*/\1/p' | tail -r)
          if [ -z "$RUNTIMES" ]; then
            echo "No available iOS simulators found"
            exit 1
          fi
          DEVICE_NAMES=("iPhone 15" "iPhone 14" "iPhone 15 Pro" "iPhone SE (3rd generation)")
          CREATED=""
          for RUNTIME_ID in $RUNTIMES; do
            for NAME in "${DEVICE_NAMES[@]}"; do
              LINE=$(xcrun simctl list devicetypes | grep -F -i "$NAME (" | head -1)
              if [ -n "$LINE" ]; then
                DTYPE_ID=$(echo "$LINE" | tr '()' '\n' | grep -E 'com\.apple\.CoreSimulator\.SimDeviceType\.' | head -1)
              else
                DTYPE_ID=""
              fi
              [ -z "$DTYPE_ID" ] && continue
              if DEVICE_UDID=$(xcrun simctl create "CM Build iPhone" "$DTYPE_ID" "$RUNTIME_ID" 2>/dev/null); then
                CREATED=1
                DEVICE_NAME="$NAME"
                SELECTED_RUNTIME="$RUNTIME_ID"
                break 2
              fi
            done
          done
          if [ -z "$CREATED" ]; then
            echo "Failed to create simulator"
            exit 1
          fi
          xcrun simctl boot "$DEVICE_UDID" || true
          xcrun simctl bootstatus "$DEVICE_UDID" -b || sleep 10
          echo "export BUILD_DEVICE_UDID=\"$DEVICE_UDID\"" >> $CM_ENV
          echo "export BUILD_DEVICE_NAME=\"$DEVICE_NAME\"" >> $CM_ENV
          echo "export BUILD_RUNTIME=\"$SELECTED_RUNTIME\"" >> $CM_ENV
          OS_VERSION=$(echo "$SELECTED_RUNTIME" | sed -nE 's/.*iOS-([0-9]+)-([0-9]+).*/\1.\2/p')
          echo "export BUILD_OS_VERSION=\"$OS_VERSION\"" >> $CM_ENV
          echo "âœ… Created simulator: $DEVICE_NAME ($DEVICE_UDID) on iOS $OS_VERSION"

      - name: Build iOS (Debug, simulator)
        script: |
          cd ios
          source $CM_ENV || true
          set -e
          if [ -n "$BUILD_DEVICE_UDID" ]; then
            echo "ðŸ“± Building for simulator UDID: $BUILD_DEVICE_UDID"
            xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Debug -sdk iphonesimulator -destination "id=$BUILD_DEVICE_UDID" -derivedDataPath build clean build | tee xcodebuild.screenshots.log
          else
            echo "âš ï¸ BUILD_DEVICE_UDID not set, falling back to generic simulator (may cause issues)"
            xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Debug -sdk iphonesimulator -destination "generic/platform=iOS Simulator" -derivedDataPath build clean build | tee xcodebuild.screenshots.log
          fi
          find_valid_app() {
            local ROOT_DIR="$1"
            local CANDIDATES
            CANDIDATES=$(find "$ROOT_DIR" -maxdepth 6 -type d -name '*.app' 2>/dev/null || true)
            for APP in $CANDIDATES; do
              if [ -f "$APP/Info.plist" ]; then
                local BID
                BID=$(/usr/libexec/PlistBuddy -c 'Print:CFBundleIdentifier' "$APP/Info.plist" 2>/dev/null || echo '')
                if [ -n "$BID" ]; then
                  echo "$APP"
                  return 0
                fi
              fi
            done
            return 1
          }

          DEFAULT_APP_PATH="$PWD/build/Build/Products/Debug-iphonesimulator/Runner.app"
          if [ -d "$DEFAULT_APP_PATH" ]; then
            SIMULATOR_APP_PATH="$DEFAULT_APP_PATH"
          else
            SIMULATOR_APP_PATH=$(find_valid_app "$PWD/build/Build/Products/Debug-iphonesimulator" || true)
          fi

          if [ -z "$SIMULATOR_APP_PATH" ] || [ ! -d "$SIMULATOR_APP_PATH" ]; then
            echo "âŒ No valid .app found after build"
            find "$PWD/build/Build/Products" -maxdepth 6 -type d -name '*.app' -print 2>/dev/null || true
            exit 1
          fi

          if [ ! -f "$SIMULATOR_APP_PATH/Info.plist" ]; then
            echo "âŒ Info.plist not found in $SIMULATOR_APP_PATH"
            ls -la "$SIMULATOR_APP_PATH" || true
            exit 1
          fi

          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print:CFBundleIdentifier' "$SIMULATOR_APP_PATH/Info.plist" 2>/dev/null || echo '')
          if [ -z "$BUNDLE_ID" ]; then
            echo "âŒ CFBundleIdentifier missing in $SIMULATOR_APP_PATH/Info.plist"
            /usr/libexec/PlistBuddy -c 'Print' "$SIMULATOR_APP_PATH/Info.plist" 2>/dev/null | head -200 || true
            exit 1
          fi

          echo "âœ… Using app: $SIMULATOR_APP_PATH"
          echo "âœ… Bundle ID: $BUNDLE_ID"
          echo "export SIMULATOR_APP_PATH=\"$SIMULATOR_APP_PATH\"" >> $CM_ENV
          echo "export BUNDLE_ID=\"$BUNDLE_ID\"" >> $CM_ENV

      - name: Capture screenshots (iPhone + iPad)
        script: |
          set -e
          source $CM_ENV || true
          mkdir -p cm-artifacts/screenshots

          if [ -z "$SIMULATOR_APP_PATH" ] || [ ! -d "$SIMULATOR_APP_PATH" ]; then
            echo "âš ï¸ SIMULATOR_APP_PATH not set or invalid, searching for app..."
            SIMULATOR_APP_PATH="$PWD/ios/build/Build/Products/Debug-iphonesimulator/Runner.app"
            if [ ! -d "$SIMULATOR_APP_PATH" ]; then
              SIMULATOR_APP_PATH=$(find "$PWD/ios/build/Build/Products" -maxdepth 5 -type d -name 'Runner.app' -print 2>/dev/null | head -1)
            fi
          fi

          if [ -z "$SIMULATOR_APP_PATH" ] || [ ! -d "$SIMULATOR_APP_PATH" ]; then
            echo "âŒ No Runner.app found"
            find "$PWD/ios/build" -name '*.app' -type d 2>/dev/null || true
            exit 1
          fi

          if [ ! -f "$SIMULATOR_APP_PATH/Info.plist" ]; then
            echo "âŒ Info.plist not found in $SIMULATOR_APP_PATH"
            ls -la "$SIMULATOR_APP_PATH" || true
            exit 1
          fi

          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print:CFBundleIdentifier' "$SIMULATOR_APP_PATH/Info.plist" 2>/dev/null || echo '')
          if [ -z "$BUNDLE_ID" ]; then
            echo "âŒ CFBundleIdentifier missing. Dumping Info.plist:"
            /usr/libexec/PlistBuddy -c 'Print' "$SIMULATOR_APP_PATH/Info.plist" 2>/dev/null | head -50 || cat "$SIMULATOR_APP_PATH/Info.plist" | head -50
            exit 1
          fi

          RUNTIME_ID=$(xcrun simctl list runtimes | grep -E '^iOS [0-9]+' | grep -v unavailable | sed -nE 's/.*(com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]+).*/\1/p' | tail -1)
          if [ -z "$RUNTIME_ID" ]; then
            echo "No available iOS runtime found"
            exit 1
          fi

          wait_for_boot() {
            local UDID="$1"
            local TRY=1
            local MAX_TRIES=3
            while [ $TRY -le $MAX_TRIES ]; do
              echo "â³ Waiting for simulator boot (try $TRY/$MAX_TRIES): $UDID" >&2
              if xcrun simctl bootstatus "$UDID" -b >&2; then
                return 0
              fi
              echo "âš ï¸ simctl bootstatus failed (often data migration). Sleeping and retrying..." >&2
              sleep 20
              TRY=$((TRY+1))
            done

            echo "âš ï¸ Continuing even though bootstatus did not report ready." >&2
            return 0
          }

          create_and_boot() {
            local DEVICE_TYPE_HINT="$1"
            local SIM_NAME="$2"
            local DEVTYPE_ID

            DEVTYPE_ID=$(xcrun simctl list devicetypes | grep -F "$DEVICE_TYPE_HINT" | head -1 | tr '()' '\n' | grep -E 'com\.apple\.CoreSimulator\.SimDeviceType\.' | head -1)
            if [ -z "$DEVTYPE_ID" ]; then
              echo "Device type not found for: $DEVICE_TYPE_HINT" >&2
              return 1
            fi

            local UDID
            UDID=$(xcrun simctl create "$SIM_NAME" "$DEVTYPE_ID" "$RUNTIME_ID")
            xcrun simctl boot "$UDID" || true
            wait_for_boot("$UDID")
            echo "$UDID"
          }

          take_set() {
            local UDID="$1"
            local PREFIX="$2"
            echo "ðŸ“± Installing app on simulator $UDID..."
            xcrun simctl install "$UDID" "$SIMULATOR_APP_PATH"
            echo "ðŸš€ Launching app..."
            xcrun simctl launch "$UDID" "$BUNDLE_ID" || true
            echo "â³ Waiting 30s for app to fully launch..."
            sleep 30
            echo "ðŸ“¸ Taking screenshots..."
            xcrun simctl io "$UDID" screenshot "cm-artifacts/screenshots/${PREFIX}-01.png" || true
            sleep 2
            xcrun simctl io "$UDID" screenshot "cm-artifacts/screenshots/${PREFIX}-02.png" || true
            sleep 2
            xcrun simctl io "$UDID" screenshot "cm-artifacts/screenshots/${PREFIX}-03.png" || true
          }

          echo "ðŸ“± Creating iPhone simulator..."
          IPHONE_UDID=$(create_and_boot "iPhone 11 Pro Max" "CM iPhone 6.5" | tail -1) || IPHONE_UDID=$(create_and_boot "iPhone XS Max" "CM iPhone 6.5" | tail -1) || IPHONE_UDID=$(create_and_boot "iPhone 14 Pro Max" "CM iPhone 6.5" | tail -1)
          if [ -n "$IPHONE_UDID" ]; then
            take_set "$IPHONE_UDID" "iphone-6.5"
          else
            echo "âš ï¸ Failed to create iPhone simulator, skipping..."
          fi

          echo "ðŸ“± Creating iPad simulator..."
          IPAD_UDID=$(create_and_boot "iPad Pro (12.9-inch) (6th generation)" "CM iPad 13" | tail -1) || \
          IPAD_UDID=$(create_and_boot "iPad Pro (12.9-inch) (5th generation)" "CM iPad 13" | tail -1) || \
          IPAD_UDID=$(create_and_boot "iPad Pro (12.9-inch)" "CM iPad 13" | tail -1) || \
          IPAD_UDID=$(create_and_boot "iPad Pro (13-inch)" "CM iPad 13" | tail -1)

          if [ -n "$IPAD_UDID" ]; then
            take_set "$IPAD_UDID" "ipad-13"
          else
            echo "âš ï¸ Failed to create iPad simulator, skipping..."
          fi

          [ -n "$IPHONE_UDID" ] && { xcrun simctl shutdown "$IPHONE_UDID" || true; xcrun simctl delete "$IPHONE_UDID" || true; }
          [ -n "$IPAD_UDID" ] && { xcrun simctl shutdown "$IPAD_UDID" || true; xcrun simctl delete "$IPAD_UDID" || true; }
    artifacts:
      - cm-artifacts/screenshots/**
      - ios/build/Build/Products/Debug-iphonesimulator/Runner.app
      - xcodebuild.screenshots.log

  ios_testflight:
    name: iOS Release - TestFlight
    max_build_duration: 60
    instance_type: mac_mini_m2
    integrations:
      app_store_connect: Codemagic CI
    environment:
      flutter: "3.35.7"
      xcode: 16.2
      cocoapods: default
      groups:
        - code-signing
    cache:
      cache_paths:
        - $HOME/Library/Caches/CocoaPods
        - ~/.cocoapods
        - ios/Pods
        - $HOME/.pub-cache
        - build
    scripts:
      - name: Flutter pub get
        script: |
          flutter --version
          flutter clean
          flutter pub get
      - name: Install CocoaPods
        script: |
          cd ios
          pod --version
          pod install --repo-update
          
          echo "Injecting warning suppression into Pods xcconfig files..."
          for xcconfig in Pods/Target\ Support\ Files/**/*.xcconfig; do
            if [ -f "$xcconfig" ]; then
              if ! grep -q "GCC_WARN_INHIBIT_ALL_WARNINGS" "$xcconfig"; then
                echo "" >> "$xcconfig"
                echo "// Warning suppression injected by Codemagic" >> "$xcconfig"
                echo "GCC_WARN_INHIBIT_ALL_WARNINGS = YES" >> "$xcconfig"
                echo "GCC_TREAT_WARNINGS_AS_ERRORS = NO" >> "$xcconfig"
                echo "SWIFT_TREAT_WARNINGS_AS_ERRORS = NO" >> "$xcconfig"
                echo "SWIFT_SUPPRESS_WARNINGS = YES" >> "$xcconfig"
                echo "GCC_WARN_ABOUT_DEPRECATED_FUNCTIONS = NO" >> "$xcconfig"
              fi
            fi
          done
          echo "Warning suppression injection complete."
      - name: Set up code signing
        script: |
          set -e
          keychain initialize
          
          echo $CM_CERTIFICATE | base64 --decode > /tmp/certificate.p12
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo $CM_PROVISIONING_PROFILE | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/manual.mobileprovision
          
          keychain add-certificates \
            --certificate /tmp/certificate.p12 \
            --certificate-password "$CM_CERTIFICATE_PASSWORD"
          
          echo "Modifying project.pbxproj..."
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/GCC_TREAT_WARNINGS_AS_ERRORS = YES;/GCC_TREAT_WARNINGS_AS_ERRORS = NO;/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/SWIFT_TREAT_WARNINGS_AS_ERRORS = YES;/SWIFT_TREAT_WARNINGS_AS_ERRORS = NO;/g' ios/Runner.xcodeproj/project.pbxproj
          
          xcode-project use-profiles
      - name: Build iOS IPA (release)
        script: |
          PROV_PROFILE=~/Library/MobileDevice/Provisioning\ Profiles/manual.mobileprovision
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(/usr/bin/security cms -D -i "$PROV_PROFILE"))
          TEAM_ID=$(/usr/libexec/PlistBuddy -c "Print :TeamIdentifier:0" /dev/stdin <<< $(/usr/bin/security cms -D -i "$PROV_PROFILE"))
          
          echo "Profile UUID: $PROFILE_UUID"
          echo "Team ID: $TEAM_ID"
          
          cat > /tmp/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$TEAM_ID</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>br.com.pratoseguro.app</key>
                  <string>$PROFILE_UUID</string>
              </dict>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          cat /tmp/ExportOptions.plist
          
          flutter build ipa --release --export-options-plist=/tmp/ExportOptions.plist
    artifacts:
      - build/ios/ipa/*.ipa
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true